name: publish

on:
  push:
    tags:
      # Date-based tags, e.g. 20250521 or 20250521-1
      - '20*'

env:
  IMAGE_NAME: ghcr.io/mah0x211/lua-ci
  LATEST_SUITE: bookworm

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      actions: write  # required to save BuildKit cache (type=gha)
    strategy:
      matrix:
        debian_suite: [bullseye, bookworm]
    steps:
      -
        name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      -
        name: Fetch tags for comparison
        run: git fetch --force --tags --prune
      -
        name: Validate tag is reachable from master
        env:
          TAG: ${{ github.ref_name }}
        run: ./validate_tag_reachable_from_master.sh
      -
        name: Validate date tag format
        shell: bash
        env:
          TAG: ${{ github.ref_name }}
        run: ./validate_tag_format.sh
      -
        name: Validate date tag order
        shell: bash
        env:
          TAG: ${{ github.ref_name }}
        run: ./validate_tag_order.sh
      -
        name: Compute image tags
        id: meta
        env:
          TAG: ${{ github.ref_name }}         # e.g. 20250521-1
          SUITE: ${{ matrix.debian_suite }}
          LATEST_SUITE: ${{ env.LATEST_SUITE }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          set -euo pipefail

          TAGS=("${IMAGE_NAME}:${SUITE}-${TAG}" "${IMAGE_NAME}:${SUITE}")
          if [[ "${SUITE}" == "${LATEST_SUITE}" ]]; then
            TAGS+=("${IMAGE_NAME}:latest")
          fi

          {
            echo 'tags<<EOF'
            for t in "${TAGS[@]}"; do
              echo "$t"
            done
            echo 'EOF'
          } | tee -a "$GITHUB_OUTPUT"
      -
        name: Build & test image
        uses: ./.github/actions/image-build
        id: build_image
        with:
          debian_suite: ${{ matrix.debian_suite }}
      -
        name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      -
        name: Push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64
          build-args: |
            DEBIAN_SUITE=${{ matrix.debian_suite }}
            LUA_PATH=${{ steps.build_image.outputs.lua_path }}
            LUA_CPATH=${{ steps.build_image.outputs.lua_cpath }}
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha,scope=${{ matrix.debian_suite }}
